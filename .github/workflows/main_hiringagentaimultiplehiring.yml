# # Docs for the Azure Web Apps Deploy action: https://github.com/azure/functions-action
# # More GitHub Actions for Azure: https://github.com/Azure/actions
# # More info on Python, GitHub Actions, and Azure Functions: https://aka.ms/python-webapps-actions

# name: Build and deploy Python project to Azure Function App - HiringAgentaiMultipleHiring

# on:
#   push:
#     branches:
#       - main
#   workflow_dispatch:

# env:
#   AZURE_FUNCTIONAPP_PACKAGE_PATH: "." # set this to the path to your web app project, defaults to the repository root
#   PYTHON_VERSION: "3.10" # set this to the python version to use (supports 3.6, 3.7, 3.8)

# jobs:
#   build:
#     runs-on: ubuntu-latest
#     permissions:
#       contents: read #This is required for actions/checkout

#     steps:
#       - name: Checkout repository
#         uses: actions/checkout@v4

#       - name: Setup Python version
#         uses: actions/setup-python@v5
#         with:
#           python-version: ${{ env.PYTHON_VERSION }}

#       # === Added: Aggressive disk cleanup before install ===
#       - name: Clean up disk space before install
#         run: |
#           sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
#           sudo apt-get clean
#           sudo du -sh /usr/* | sort -h
#           df -h

#       - name: Create and start virtual environment
#         run: |
#           python -m venv venv
#           source venv/bin/activate

#       - name: Install dependencies
#         run: |
#           # Install packages directly in the project root for Azure Functions
#           pip install --upgrade pip
#           pip install -r requirements.txt -t .

#       - name: Verify dependencies installation
#         run: |
#           echo "Checking installed packages in root:"
#           ls -la | grep -E "(azure|python)" || echo "No azure/python folders found in root"
#           echo "Looking for azure.durable_functions:"
#           find . -name "*durable*" -type d | head -10 || echo "No durable folders found"
#           echo "Checking for azure modules:"
#           find . -path "./venv" -prune -o -name "azure*" -type d -print | head -10

#       # Optional: Add step to run tests here

#       - name: Zip artifact for deployment
#         run: |
#           # Include .python_packages in the zip for Azure Functions
#           zip -r release.zip . -x "venv/*" "*.git*" "*__pycache__*" "*.pytest_cache*" "*.mypy_cache*" "*.pyc"

#       - name: Upload artifact for deployment job
#         uses: actions/upload-artifact@v4
#         with:
#           name: python-app
#           path: |
#             release.zip

#   deploy:
#     runs-on: ubuntu-latest
#     needs: build
#     permissions:
#       id-token: write #This is required for requesting the JWT
#       contents: read #This is required for actions/checkout

#     steps:
#       # === Added: Disk cleanup before deploy ===
#       - name: Clean up disk space before deploy
#         run: |
#           sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
#           sudo apt-get clean
#           sudo du -sh /usr/* | sort -h
#           df -h

#       - name: Download artifact from build job
#         uses: actions/download-artifact@v4
#         with:
#           name: python-app

#       - name: Unzip artifact for deployment
#         run: unzip release.zip

#       - name: Login to Azure
#         uses: azure/login@v2
#         with:
#           client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_E477DE97BA1A4CE9B4E43D1CE2CF1BE3 }}
#           tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_0C4002EDCC17451986A2F5EF2FC9C1C6 }}
#           subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_B8807E494C724C5C9A22CF6432EE2262 }}

#       - name: "Deploy to Azure Functions"
#         uses: Azure/functions-action@v1
#         id: deploy-to-function
#         with:
#           app-name: "HiringAgentaiMultipleHiring"
#           slot-name: "Production"
#           package: release.zip








name: Build and deploy Python Azure Function - HiringAgentaiMultipleHiring

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.10"
  PACKAGE_NAME: "release.zip"

permissions:
  contents: read
  id-token: write

jobs:
  build:
    name: Build package
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Clean previously committed packages (safe-guard)
        run: |
          # Remove common package folders if accidentally committed at repo root
          rm -rf azure* openai* pandas* numpy* google* site-packages* .python_packages || true
          # remove venv and caches
          rm -rf venv .venv .pytest_cache __pycache__ .mypy_cache || true
          echo "Cleaned possible leftover package folders."

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Create Python venv & upgrade pip
        run: |
          python -m venv venv
          source venv/bin/activate
          python -m pip install --upgrade pip setuptools wheel
          pip --version

      - name: Install dependencies into Azure Functions layout (.python_packages)
        run: |
          source venv/bin/activate
          # install into expected functions site-packages path
          mkdir -p .python_packages/lib/site-packages
          pip install -r requirements.txt --target=".python_packages/lib/site-packages"
          echo "Installed to .python_packages/lib/site-packages"
          du -sh .python_packages || true

      - name: Sanity check - List function files and packages
        run: |
          echo "host.json exists?"
          test -f host.json && echo "OK: host.json present" || echo "MISSING: host.json"
          echo "requirements.txt exists?"
          test -f requirements.txt && echo "OK: requirements.txt present" || echo "MISSING: requirements.txt"
          echo "Top-level folders:"
          ls -la | sed -n '1,200p'
          echo ".python_packages contents:"
          find .python_packages -maxdepth 3 -type f -print | sed -n '1,200p' || echo "no .python_packages files found"

      - name: Create release.zip (zip the contents - include .python_packages)
        run: |
          rm -f ${{ env.PACKAGE_NAME }}
          # Zip everything in the repo root (this makes files appear at root in the zip)
          zip -r ${{ env.PACKAGE_NAME }} . \
            -x "venv/*" ".git/*" ".github/*" "node_modules/*" "__pycache__/*" ".pytest_cache/*" ".mypy_cache/*" "*.pyc" "*/.DS_Store"
          echo "Created ${{ env.PACKAGE_NAME }}"

      - name: Verify archive contents & size
        run: |
          echo "Archive size:"
          du -sh ${{ env.PACKAGE_NAME }} || true
          echo "Archive listing (first 200 lines):"
          unzip -l ${{ env.PACKAGE_NAME }} | sed -n '1,200p'

      - name: Upload artifact for deploy
        uses: actions/upload-artifact@v4
        with:
          name: python-app
          path: ${{ env.PACKAGE_NAME }}

  deploy:
    name: Deploy to Azure Function
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: python-app
          path: .

      - name: Unzip artifact (verify)
        run: |
          unzip -o release.zip -d extracted || true
          echo "Top-level files in extracted folder:"
          ls -la extracted | sed -n '1,200p'

      - name: Login to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Ensure Function App doesn't run Oryx remote build (recommended)
        run: |
          # Replace APP_NAME with your function app name if not using AZURE_APP_NAME secret
          APP_NAME="${{ secrets.AZURE_APP_NAME }}"
          RG=$(az functionapp show --name "$APP_NAME" --query "resourceGroup" -o tsv)
          echo "Setting SCM_DO_BUILD_DURING_DEPLOYMENT=false (disable remote build Oryx) for $APP_NAME in $RG"
          az functionapp config appsettings set --name "$APP_NAME" --resource-group "$RG" --settings SCM_DO_BUILD_DURING_DEPLOYMENT=false || true
          # optional: enable WEBSITE_RUN_FROM_PACKAGE=1 to run from zip package
          az functionapp config appsettings set --name "$APP_NAME" --resource-group "$RG" --settings WEBSITE_RUN_FROM_PACKAGE=1 || true

      - name: Deploy to Azure Functions (ZIP deploy)
        id: deploy-to-function
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ secrets.AZURE_APP_NAME }}
          slot-name: "Production"
          package: release.zip

      - name: Show deployment logs (if deploy failed, this helps)
        if: failure()
        run: |
          APP_NAME="${{ secrets.AZURE_APP_NAME }}"
          RG=$(az functionapp show --name "$APP_NAME" --query "resourceGroup" -o tsv)
          echo "Fetching deployment logs for $APP_NAME in resource group $RG"
          az webapp log deployment show --name "$APP_NAME" --resource-group "$RG" || true
          echo "Also listing kudu deployment center logs (if present):"
          az rest --method get --uri "https://management.azure.com/subscriptions/${{ secrets.AZURE_SUBSCRIPTION_ID }}/resourceGroups/$RG/providers/Microsoft.Web/sites/$APP_NAME/deployments?api-version=2022-03-01" || true

      - name: Success message
        if: success()
        run: echo "Deployment completed successfully."

